<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>♟️ SJAKKARO - AI Sjakktrener</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

  <!-- External JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.1/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <!-- Configuration and Prompts -->
  <script src="config.js"></script>
  <script src="prompts.js"></script>
</head>
<body>
  <div class="app">
    <header class="app-head">
      <div>
        <div class="brand">♟️ SJAKKARO</div>
      </div>
      <div class="header-controls">
        <button class="panel-toggle" id="panelToggle" aria-expanded="false">Trekk & analyse ▸</button>
        <button class="btn btn--ghost" id="configBtn" title="Konfigurasjon" style="margin-left:8px;">⚙️</button>
      </div>
    </header>

    <nav class="tabs" id="tabs" aria-label="Kategorier">
      <button class="tab" data-c="opening" aria-selected="true">Åpning</button>
      <button class="tab" data-c="tactics">Taktikk</button>
      <button class="tab" data-c="strategy">Strategi</button>
      <button class="tab" data-c="endgame">Sluttspill</button>
      <button class="tab" data-c="skills">Kjerneferdigheter</button>
    </nav>

    <section class="lesson-card">
      <div class="lesson-grid">
        <div>
          <div class="board-title" id="boardTitle">Last opp parti for analyse</div>
          <div class="board-wrap">
            <div id="board" aria-label="interaktivt sjakkbrett"></div>
            <div class="dkart-overlay" id="dkart" hidden></div>
          </div>

          <div class="explain annotate" id="explainBox">
            <h3>Velkommen til Sjakkaro</h3>
            <p>
              Last opp et parti med PGN-knappen for å få avansert analyse.
              Systemet evaluerer stillinger med <span class="gloss" data-def="Kraftig sjakkmotor for posisjonsvurdering.">Stockfish</span>
              og genererer <span class="gloss" data-def="AI-basert analyse av nøkkeløyeblikk i partiet.">AI‑coaching</span>.
            </p>
          </div>

          <div class="chat-panel" id="chatPanel" style="display: none; margin-top: 14px;">
            <div class="chat-history" id="chatHistory" style="background:#0c152d; border:1px solid #1a2a55; border-radius:12px; padding:10px; line-height:1.55; max-height:180px; overflow-y:auto; margin-bottom: 8px;">
              <!-- Meldinger fra chatten vil vises her -->
            </div>
            <div class="chat-input-area" style="display: flex; gap: 8px;">
              <input type="text" id="chatInput" class="form-input" placeholder="Still et spørsmål til AI-coachen...">
              <button class="btn btn--primary" id="chatSendBtn">Send</button>
            </div>
          </div>
        </div>

        <aside class="sidepanel" id="sidepanel" aria-label="Trekk og analyse">
          <div class="panel-head">
            <div class="game-meta-info" id="gameMetaInfo">
              <!-- Dynamisk: Tid/Resultat -->
            </div>
            <div class="nav-buttons">
              <button class="btn btn--ghost" id="btnStart" title="Gå til start (Pil ned)">«</button>
              <button class="btn" id="btnPrev" title="Forrige (←)">←</button>
              <button class="btn" id="btnNext" title="Neste (→)">→</button>
              <button class="btn btn--ghost" id="btnEnd" title="Gå til siste trekk">»</button>
            </div>
          </div>

          <!-- Player Info Panel -->
          <div class="player-info-panel" id="playerInfoPanel" style="display: none;">
            <div class="player-line white">
              <span class="player-name" id="whitePlayerName"></span>
              <span class="player-rating" id="whitePlayerRating"></span>
              <span class="player-rating-diff" id="whitePlayerRatingDiff"></span>
            </div>
            <div class="player-line black">
              <span class="player-name" id="blackPlayerName"></span>
              <span class="player-rating" id="blackPlayerRating"></span>
              <span class="player-rating-diff" id="blackPlayerRatingDiff"></span>
            </div>
          </div>

          <div class="move-list" id="moveList" role="list" aria-live="polite"></div>
					<div id="evalGraph" class="eval-graph" aria-label="Evalueringsgraf"></div>

          <div class="action-buttons" aria-label="Verktøy">
            <button class="btn" id="btnDkart" aria-pressed="false">Dkart</button>
            <button class="btn" id="btnPositionAnalysis" disabled>Analyse</button>
            <button class="btn" id="btnAnalyze">Lichess</button>
            <button class="btn btn--primary" id="btnPGN">PGN</button>
          </div>

          <!-- Åpningsinfo-panel -->
          <div class="opening-info-panel" id="openingInfoPanel" style="display:none;">
              <h4 class="opening-name" id="openingName">Åpningsnavn</h4>
              <div id="openingStatsContainer">
                  <!-- Dynamisk innhold lastes her -->
              </div>
              <div class="opening-description" id="openingDescription">
                  <p id="aiOpeningText">AI-generert beskrivelse lastes her...</p>
              </div>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <!-- Configuration Modal -->
  <div class="modal" id="configModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">⚙️ Konfigurasjon</h2>
        <button class="close-btn" id="closeConfigModal">&times;</button>
      </div>

      <div class="modal-section">
        <div class="section-title">🤖 Stockfish Motor</div>
        <div class="helpbar">
          <span class="help">Modus:
            <label><input type="radio" name="mode" value="movetime" checked> tid</label>
            <label><input type="radio" name="mode" value="depth"> dybde</label>
          </span>
          <span class="help">ms/trekk: <input id="mtInput" type="number" min="200" max="5000" step="100" value="1500" style="width:80px"></span>
          <span class="help">Depth: <input id="depthInput" type="number" min="8" max="24" value="18" style="width:60px"></span>
          <span class="help">MultiPV: <input id="mpvInput" type="number" min="1" max="5" value="3" style="width:50px"></span>
        </div>
      </div>

      <div class="modal-section">
        <div class="section-title">📚 Åpningsbok (Lichess)</div>
        <div class="helpbar">
          <span class="help">Åpningsbok: <input type="checkbox" id="openingEnabled" checked></span>
          <span class="help">Strategi:
            <select id="openingStrategy" style="width:80px;font-size:11px;">
              <option value="balanced" selected>Balansert</option>
              <option value="popular">Populær</option>
              <option value="performance">Resultat</option>
              <option value="random">Tilfeldig</option>
            </select>
          </span>
          <span class="help">Min partier: <input id="minGamesInput" type="number" min="50" max="1000" step="50" value="100" style="width:60px"></span>
          <span class="help">Max trekk: <input id="maxPliesInput" type="number" min="10" max="40" step="5" value="20" style="width:50px"></span>
        </div>
      </div>

      <!-- AI-innstillinger -->
      <div class="modal-section">
        <div class="section-title">🤖 AI</div>

        <div class="form-group">
          <label class="form-label" for="aiModelSelector">Velg AI-modell</label>
          <select id="aiModelSelector" class="form-select"></select>
        </div>

        <div class="form-group">
          <label class="form-label" for="elevRatingInput">Ditt estimerte ratingnivå</label>
          <input id="elevRatingInput" type="number" class="form-input" min="400" max="2400" step="50" placeholder="f.eks. 800">
        </div>

        <div class="form-group">
          <label class="form-label" for="geminiApiKeyInput">Gemini API-nøkkel</label>
          <input id="geminiApiKeyInput" type="password" class="form-input" placeholder="Lim inn nøkkel her">
        </div>

        <div class="form-group">
          <label class="form-label" for="groqApiKeyInput">Groq API-nøkkel</label>
          <input id="groqApiKeyInput" type="password" class="form-input" placeholder="Lim inn nøkkel her">
        </div>

        <small>Tips: Nøklene lagres lokalt i nettleseren (localStorage) på denne maskinen.</small>
      </div>

      <!-- Dkart vekting -->
      <div class="modal-section">
        <div class="section-title">🎯 Dkart Vekting</div>

        <div class="form-group">
          <label class="form-label" for="weightPresetSelector">Vektpreset</label>
          <select id="weightPresetSelector" class="form-select">
            <option value="standard">Standard (sentrum 4x)</option>
            <option value="center_focus">Kun sentrum</option>
            <option value="equal">Alle felt likt</option>
            <option value="endgame_focus">Sluttspillsfokus</option>
            <option value="custom">Egendefinert</option>
          </select>
        </div>

        <div class="preset-info" id="presetInfo">
          <span id="presetDescription">Sentrum (d4,d5,e4,e5) vekt 4, utvidet sentrum vekt 2, resten vekt 1</span>
        </div>

        <div class="weight-matrix-editor" id="weightMatrixEditor">
          <label class="form-label">Vektmatrise (0-9)</label>
          <div class="matrix-container">
            <div class="matrix-row-labels" id="matrixRowLabels">
              <div>8</div><div>7</div><div>6</div><div>5</div><div>4</div><div>3</div><div>2</div><div>1</div>
            </div>
            <div class="matrix-with-labels">
              <div class="matrix-col-labels">
                <div>a</div><div>b</div><div>c</div><div>d</div><div>e</div><div>f</div><div>g</div><div>h</div>
              </div>
              <div class="matrix-grid" id="weightMatrix">
                <!-- 8x8 grid genereres dynamisk med JavaScript -->
              </div>
            </div>
          </div>
          <div class="matrix-legend">
            0 = Ignoreres, 1-9 = Vektfaktor (høyere = viktigere felt)
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" id="resetConfigBtn">Tilbakestill</button>
        <button class="btn btn--primary" id="saveConfigBtn">Lagre</button>
      </div>
    </div>
  </div>

  <!-- PGN Modal -->
  <div class="modal" id="pgnModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">📥 Last opp parti</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>

      <div id="errorMessage" class="error-message" style="display:none"></div>
      <div id="loadingMessage" class="loading-message" style="display:none"></div>

      <div class="modal-section">
        <div class="section-title">📋 Fra Lichess</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="lichessUsername">Brukernavn</label>
            <input type="text" id="lichessUsername" class="form-input" placeholder="@olanord" />
          </div>
          <div class="form-group">
            <label class="form-label" for="numGames">Antall</label>
            <input type="number" id="numGames" class="form-input" min="1" value="1" />
          </div>
        </div>
        <button class="btn btn--primary" id="fetchLichessBtn">Hent partier fra Lichess</button>
      </div>

      <div class="modal-section">
        <div class="section-title">📁 Fra fil</div>
        <input type="file" id="pgnFile" accept=".pgn" style="display:none" />
        <button class="btn btn--primary" id="loadFileBtn">Last opp fra fil</button>
      </div>

      <div class="modal-section" id="gameSelectSection" style="display:none">
        <div class="section-title">Velg parti</div>
        <div class="form-group">
          <label class="form-label" for="gameSelect">Velg parti</label>
          <select id="gameSelect" class="form-select"></select>
        </div>
        <button class="btn btn--primary" id="selectGameBtn">Last valgt parti</button>
      </div>

      <div class="modal-section">
        <div class="section-title">✏️ Lim inn PGN</div>
        <div class="form-group">
          <label class="form-label" for="pgnText">PGN-data</label>
          <textarea id="pgnText" class="form-textarea" placeholder="Lim inn PGN her..."></textarea>
        </div>
        <button class="btn btn--primary" id="loadTextBtn">Last parti fra tekst</button>
      </div>

      <div class="modal-footer">
        <button class="btn" id="cancelBtn">Avbryt</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- Application JavaScript -->
  <script src="app.js"></script>
</body>
</html>
